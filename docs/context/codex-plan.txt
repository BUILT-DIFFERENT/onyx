Onyx Android Full-Transformation Program (Samsung Notes + Notewise Tier)
Summary
This plan transforms Onyx from a strong MVP into a production-grade Android note system with top-tier writing feel, organization, PDF workflows, and unified search. It explicitly incorporates deltas from your three attached analyses (subagent-reviewed) and makes final architecture decisions now so implementation can proceed without ambiguity.
Primary strategy: custom render pipeline + offscreen MyScript recognition + unified searchable content model + modern library/editor UX, with measurable performance gates per stage.

In Scope / Out of Scope
In scope:
C:/onyx/apps/android full architecture, rendering, storage, editor UX, library UX, PDF UX, search/indexing, docs, tests, CI quality gates.
Stylus-first behavior: pressure/tilt, button actions, hover cursor, palm rejection.
Unified search across note titles, handwriting recognition, and PDF text.
Out of scope:
Legacy local DB backward compatibility and old-data migration (explicitly excluded per your policy).
Cloud multi-user collaboration rollout (only sync-ready local contracts are included here, not full networked CRDT launch).
Important API / Interface / Type Changes
New rendering interfaces:
InkRenderBackend with implementations InkAuthoringBackend and FrontBufferedBackend.
CommittedStrokeTileStore for cached committed-stroke tiles.
StrokeGeometryPipeline for smoothing, width mapping, tapering, and blend behavior.
New document interfaces:
PdfTileProvider, PdfTextIndexProvider, PdfOutlineProvider.
New domain services:
LibraryService, SearchService, RecognitionIngestionService, ThumbnailService.
New/updated data types (Room):
FolderEntity (hierarchical via parentFolderId), TagEntity, NoteTagEntity, ThumbnailEntity, TemplateEntity, UserPreferenceEntity, StylusPreferenceEntity.
SearchDocumentEntity (FTS5-backed) + SearchHitEntity (page/geometry anchors).
StrokeEntity updated for vector-first payload and segment-aware edits.
UI contract changes:
Home route supports folder/tag/filter/sort/multi-select context.
Editor route supports explicit mode and page anchor.
Build/monorepo contract changes:
turbo.json declares required env keys in env/globalEnv.
Relevant Turbo tasks include .env* in task inputs for cache invalidation correctness.
Stage 0 — Program Lock + Performance Baseline (Week 1)
Lock architecture decisions before feature coding:
Use offscreen MyScript integration (recognition only), not MyScript EditorView as primary UI.
Use dual rendering backend abstraction with default backend by device capability.
Keep MuPDF as primary PDF engine for this program; no commercial PDF SDK in this roadmap.
Add measurable baseline instrumentation:
Macrobenchmark module with StartupTimingMetric and FrameTimingMetric.
Runtime jank tracking (JankStats), memory allocation counters, native heap tracking.
Define SLOs:
Ink tip-to-photon perceived latency p95 <= 18ms on target 120Hz tablet.
Pan/zoom frame deadline miss rate < 2% in 10-minute stress run.
PDF open (300 pages) first interactive < 2.5s; page switch cached < 50ms.
Search result first page < 150ms for 10k indexed terms.
CI gate updates:
bun run lint:all
bun run typecheck
bun run android:lint
bun run android:test
bun run ktlint
bun run detekt
Stage 1 — Editor Architecture Refactor + Rendering Foundation (Weeks 2-3)
Refactor monolith editor composition:
Split NoteEditorUi.kt into scaffold, topbar, tool panels, canvas scene, and dialogs.
Keep NoteEditorViewModel.kt as explicit owner of editor state/events; remove ad-hoc UI logic leakage.
Introduce rendering orchestration:
Create rendering/ink package and backend interface.
Move wet-ink and committed-ink responsibilities out of screen composables.
Implement wet-ink backend behavior:
Keep InProgressStrokesView active for in-progress strokes.
Implement deterministic finish handoff via finished-stroke listener and same-frame commit queue to eliminate pop-in/ghosting.
Add FrontBufferedBackend for supported devices using front-buffered rendering path; fallback to authoring backend when unsupported.
Acceptance:
No one-frame stroke disappearance on pen-up.
No full-scene redraw on each pointer move.
Editor file complexity reduced and testability improved.
Stage 2 — Ink Engine V2 (Quality + Throughput) (Weeks 4-6)
Replace brute-force draw path:
Build committed stroke tile cache keyed by page/tile/zoom bucket.
Only invalidate impacted tiles on commit/erase/segment-split.
Implement real stroke geometry pipeline:
Adaptive Catmull-Rom smoothing.
Pressure + velocity width curve (non-linear).
Start/end tapering.
Anti-aliased outline fill.
Highlighter blend mode tuned for PDF/text readability.
Stabilization semantics fix:
Stabilization slider controls input smoothing/lag tradeoff only.
Brush size/opacity remain independent controls.
Add selection/eraser primitives:
Lasso selection, transform matrix commit.
Segment eraser as first-class operation with deterministic stroke fragmentation.
Stylus and touch behavior:
Palm rejection heuristics.
Stylus hover preview cursor.
Stylus button quick-erase and configurable mappings.
Acceptance:
20k-stroke canvas pan/zoom remains within frame SLO.
Visual quality parity target achieved for curves, overlap, and tapering.
Stage 3 — Data Model V3 + Unified Search Index (Weeks 7-8)
Perform schema reset to V3 (no old DB compatibility burden).
Replace mixed legacy assumptions with clean vector-first storage.
Implement durable forward migration strategy from V3 onward.
Update OnyxDatabase.kt and entities/DAOs:
Folder hierarchy with breadcrumb queries.
Tags and note-tag joins.
Preferences tables for tool, stylus, layout, and behavior.
Thumbnails and template metadata.
Unified search model:
FTS5-backed index for titles, handwriting text, and PDF text.
Geometry anchor table for page-level highlight/jump targets.
Recognition ingestion:
Parse MyScript outputs into searchable tokens.
Coordinate transform normalization for reliable highlight placement.
Acceptance:
Fresh DB startup stable.
Search index rebuild deterministic and resumable.
Query correctness verified across mixed sources.
Stage 4 — Library/Home Experience Parity (Weeks 9-10)
Rebuild HomeScreen.kt around workspace mental model:
Grid/list toggle with visual thumbnails.
Folder tree + breadcrumb navigation.
Tag filters, pinned/favorites, sort options.
Metadata-rich cards (updated time, source type, page count).
Multi-select and batch actions:
Move, tag, pin/unpin, delete, export.
Fast entry/capture flow:
Create note in one tap from home.
Preserve last-view context per note for return continuity.
Thumbnail pipeline:
Background generation on save/idle.
Invalidation by note content hash.
Acceptance:
Library scales smoothly to 1k+ notes.
Retrieval-by-recognition UX (scan, not read) is achieved.
Stage 5 — Editor UX Parity (Samsung + Notewise Hybrid) (Weeks 11-13)
Toolbar and panel model:
Always-visible top pill groups.
Contextual floating tool panels.
Optional dockable/floating tool strip ergonomics.
Toolset completeness:
Pen/highlighter/eraser/lasso/shape/text/image insertion.
Tape tool for study workflows.
Zoom box for precision writing mode.
Color and brush controls:
Spectrum picker + swatches + hex.
Persisted presets and per-tool memory.
Template system:
Paper types, density sliders, line/grid variants.
Read-only mode behavior:
Keep zoom/pan/select active.
Block editing inputs only.
Acceptance:
Tool switching does not interrupt writing flow.
UX parity achieved for discoverability and ergonomics.
Stage 6 — PDF First-Class Engine (Weeks 14-16)
Rework PdfRenderer.kt into tiled renderer service:
Tile pyramid by zoom bucket.
Background render queue with cancellation and priority.
Bitmap pooling + strict cache budgets.
Page interaction features:
Thumbnail strip, page jump, outline navigation.
Text selection/copy with stable anchors.
Search inside PDF with jump and highlight.
Layering correctness:
Ink/highlighter compositing tuned for readable text.
Support optional smart-invert view mode as user preference.
Session continuity:
Open to last page/zoom/position.
Acceptance:
Repeated open/close loops show no native resource leaks.
Zoom/pan remains stable on large documents.
Stage 7 — Recognition UX + Semantic Recall (Weeks 17-18)
Recognition visibility and trust:
Optional recognition overlay aligned to ink.
Per-note index status and background progress.
Lasso-to-text conversion:
Select handwriting region, convert to editable text block.
Keep original ink with reversible action history.
Global semantic search:
Single query returns mixed hits (title/ink/pdf) with source labels and precise jump targets.
Acceptance:
Users can reliably find content regardless of input modality.
Recognition and search behavior is deterministic and debuggable.
Stage 8 — Hardening, Docs, and Release Readiness (Weeks 19-20)
Complete documentation set in C:/onyx/docs/android/:
ARCHITECTURE.md, RENDERING.md, STORAGE.md, PDF.md, SEARCH.md, QUALITY.md.
Expand automated coverage:
Unit tests for geometry, indexing, serialization, DAOs.
Instrumentation tests for editor tools, read-only routing, stylus mappings.
Macrobench regression suite integrated into CI.
Device matrix verification:
At least one Samsung tablet, one non-Samsung stylus tablet.
Release gating:
No open P0/P1 defects.
All SLOs green for two consecutive runs.
Test Cases and Validation Scenarios
Performance:
Startup cold/warm/hot benchmarks.
5k/10k/20k stroke stress write and pan/zoom.
300-page PDF navigation and zoom stress.
Rendering correctness:
Pen taper and pressure snapshots.
Highlighter overlap and blend correctness.
Segment eraser split invariants.
Data correctness:
DB schema tests for all entities/relations.
FTS query correctness across title/ink/pdf.
Coordinate anchor tests for search highlight placement.
UX/interaction:
Tool switching continuity.
Lasso transform and undo/redo integrity.
Multi-select library operations and folder moves.
Reliability:
Process death/restart state restoration.
Resource leak checks for repeated PDF sessions.
Assumptions and Defaults (Explicit)
Backward compatibility with older local app DB versions is intentionally not required.
Android minSdk remains 28; advanced low-latency backend uses capability checks with fallback when required.
MuPDF remains the PDF engine in this roadmap.
Offscreen MyScript recognition architecture is mandatory; MyScript EditorView is not used as the main editor surface.
Collaboration sync remains a future program; this plan delivers local determinism and sync-ready contracts.